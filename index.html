<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROTA · Painel Único</title>
  <meta name="description" content="Painel único para unificar Bate-Ponto, RSO Online e módulos adicionais (GTA RP Polícia)" />
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
  <style>
    html, body, #root { height: 100%; }
    body { background: #020617; } /* slate-950 */
  </style>
</head>
<body class="dark">
  <div id="root"></div>

  <!-- React + Babel + Supabase -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const CONFIG = {
      brand: { name: "ROTA · Painel Único", badge: "GTA RP" },
      apps: [
        { id: "ponto", name: "Bate-Ponto", type: "iframe", url: "https://gabrielsaleh1.github.io/Ponto-Online", note: "Sistema de ponto online" },
        { id: "rso", name: "RSO Online", type: "iframe", url: "https://gabrielsaleh1.github.io/RSO-Online", note: "Relatório de Serviço Online" },
      ],
    };

    const SUPABASE_ENV = {
      url: "https://ilonwkgtdszmpcjwlezc.supabase.co",
      anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0",
      tables: { rso_items: "rso_items" },
    };

    function Sidebar({ items, activeId, onSelect }) {
      return (
        <aside className="w-64 shrink-0 border-r border-white/10 bg-slate-900/40 backdrop-blur">
          <div className="p-4 border-b border-white/10">
            <div className="text-xs uppercase tracking-widest text-slate-400">{CONFIG.brand.badge}</div>
            <div className="font-black text-lg">{CONFIG.brand.name}</div>
          </div>
          <nav className="p-2 space-y-1">
            {items.map((it) => (
              <button key={it.id} onClick={() => onSelect(it.id)}
                className={`w-full text-left px-3 py-2 rounded-xl transition border ${
                  activeId === it.id
                    ? "bg-amber-500 text-slate-900 border-amber-400"
                    : "border-white/10 hover:bg-white/5"
                }`}>
                <div className="font-semibold text-sm">{it.name}</div>
                {it.note && <div className="text-xs text-slate-400">{it.note}</div>}
              </button>
            ))}
            <div className="pt-2 mt-2 border-t border-white/10 text-slate-400 text-xs">Módulos</div>
            <button onClick={() => onSelect("analytics")}
              className={`w-full text-left px-3 py-2 rounded-xl transition border ${
                activeId === "analytics"
                  ? "bg-amber-500 text-slate-900 border-amber-400"
                  : "border-white/10 hover:bg-white/5"
              }`}>
              <div className="font-semibold text-sm">Ilícitos (7 dias)</div>
              <div className="text-xs text-slate-400">Resumo por policial</div>
            </button>
            <button onClick={() => onSelect("configs")}
              className={`w-full text-left px-3 py-2 rounded-xl transition border ${
                activeId === "configs"
                  ? "bg-amber-500 text-slate-900 border-amber-400"
                  : "border-white/10 hover:bg-white/5"
              }`}>
              <div className="font-semibold text-sm">Configurações</div>
              <div className="text-xs text-slate-400">URLs & integrações</div>
            </button>
          </nav>
          <div className="p-3 mt-auto text-[11px] text-slate-500">
            <div>v0.2 — painel unificado</div>
          </div>
        </aside>
      );
    }

    function Topbar({ title, children }) {
      return (
        <header className="sticky top-0 z-10 bg-slate-950/70 backdrop-blur border-b border-white/10">
          <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
            <div className="h-9 w-9 rounded-lg grid place-items-center font-black border border-amber-500/40 bg-slate-900/60">R</div>
            <div className="font-bold">{title}</div>
            <div className="ml-auto flex items-center gap-2">{children}</div>
          </div>
        </header>
      );
    }

    function Frame({ url }) {
      return (
        <div className="h-[calc(100vh-120px)]">
          {url ? (
            <iframe title="app-frame" src={url} className="w-full h-full rounded-xl border border-white/10"></iframe>
          ) : (
            <div className="h-full grid place-items-center text-slate-400">
              <div className="text-center">
                <div className="text-lg font-semibold mb-1">Cole a URL do app nas Configurações</div>
                <div className="text-sm">Módulo do tipo <b>iframe</b></div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function useSupabase(env) {
      const [client, setClient] = useState(null);
      useEffect(() => {
        if (!env?.url || !env?.anonKey) return;
        setClient(window.supabase.createClient(env.url, env.anonKey));
      }, [env?.url, env?.anonKey]);
      return client;
    }

    function AnalyticsIllicitos({ env }) {
      const supa = useSupabase(env);
      const [loading, setLoading] = useState(false);
      const [rows, setRows] = useState([]);
      const [error, setError] = useState("");

      async function load() {
        if (!supa) return;
        setLoading(true);
        setError("");
        try {
          const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
          const { data, error } = await supa
            .from(env.tables.rso_items)
            .select("officer,item_type,quantity,recorded_at")
            .gte("recorded_at", cutoff);
          if (error) throw error;
          setRows(data || []);
        } catch (e) {
          setError(e.message || "Falha ao carregar dados");
        } finally {
          setLoading(false);
        }
      }

      const agg = useMemo(() => {
        const out = {};
        rows.forEach((r) => {
          const off = r.officer || "—";
          out[off] ||= {};
          out[off][r.item_type] = (out[off][r.item_type] || 0) + Number(r.quantity || 0);
        });
        return out;
      }, [rows]);

      return (
        <div className="p-4">
          <div className="flex items-center gap-3 mb-3">
            <h2 className="text-lg font-bold">Ilícitos — últimos 7 dias</h2>
            <button onClick={load} className="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-sm">Atualizar</button>
            <div className="ml-auto text-xs text-slate-400">Fonte: Supabase</div>
          </div>

          {!env?.url || !env?.anonKey ? (
            <div className="text-slate-400 text-sm">Preencha as credenciais do Supabase no topo do arquivo.</div>
          ) : loading ? (
            <div className="text-slate-400 text-sm">Carregando…</div>
          ) : error ? (
            <div className="text-red-400 text-sm">{error}</div>
          ) : Object.keys(agg).length === 0 ? (
            <div className="text-slate-400 text-sm">Sem dados nos últimos 7 dias.</div>
          ) : (
            <div className="grid md:grid-cols-2 gap-4">
              {Object.keys(agg).sort().map((off) => (
                <div key={off} className="rounded-xl border border-white/10 p-3 bg-slate-900/40">
                  <div className="font-semibold mb-2">{off}</div>
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="text-slate-400">
                        <th className="text-left py-1">Item</th>
                        <th className="text-right py-1">Qtd</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(agg[off]).sort().map(([item, total]) => (
                        <tr key={item} className="border-t border-white/5">
                          <td className="py-1">{item}</td>
                          <td className="py-1 text-right">{total}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function App() {
      const [active, setActive] = useState("ponto");
      const items = [
        ...CONFIG.apps,
        { id: "analytics", name: "Ilícitos (7 dias)", type: "module" },
        { id: "configs", name: "Configurações", type: "module" },
      ];
      const activeItem = items.find((x) => x.id === active);

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100">
          <Topbar title={activeItem?.name || CONFIG.brand.name}></Topbar>
          <div className="max-w-7xl mx-auto p-4 flex gap-4">
            <Sidebar items={items} activeId={active} onSelect={setActive} />
            <main className="flex-1">
              {activeItem?.type === "iframe" && <Frame url={activeItem.url} />}
              {activeItem?.id === "analytics" && <AnalyticsIllicitos env={SUPABASE_ENV} />}
            </main>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
