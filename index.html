<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROTA ¬∑ Painel √önico</title>
  <meta name="description" content="Painel √∫nico para unificar sistemas e documentos do Batalh√£o (GTA RP Pol√≠cia)" />
  <!-- Seguran√ßa b√°sica para impedir que este painel injete/edite algo em outros dom√≠nios -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://unpkg.com https://cdn.tailwindcss.com; frame-src https://docs.google.com https://gabrielsaleh1.github.io; connect-src 'self' https://gabrielsaleh1.github.io; img-src 'self' data:; style-src 'unsafe-inline' https://cdn.tailwindcss.com; script-src 'self' https://unpkg.com 'unsafe-eval';">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: {} } }
  </script>
  <style>
    html, body, #root { height: 100%; }
    body { background: #020617; } /* slate-950 */
  </style>
</head>
<body class="dark">
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState, useEffect } = React;

    // ----------------- URLs E CONFIG -----------------
    const RAW_LINKS = {
      // Sistemas
      ponto: "https://gabrielsaleh1.github.io/Ponto-Online",
      rso: "https://gabrielsaleh1.github.io/RSO-Online",

      // Hierarquia (somente visualiza√ß√£o)
      hierarquiaPublicView: "https://gabrielsaleh1.github.io/Hierarquia?view=1",
      // Fonte de dados SOMENTE-LEITURA da hierarquia (JSON p√∫blico hospedado no site original).
      // üëâ Ajuste a URL abaixo para o endpoint de dados real do seu projeto (ex.: /Hierarquia/data.json ou /api/hierarquia.json)
      hierarquiaData: "https://gabrielsaleh1.github.io/Hierarquia/data.json",

      // Documentos do Batalh√£o
      fardamentos: "docs.google.com/spreadsheets/u/1/d/15q-JK8zUxIMMAAp_ssNFRrNsddTfGIJHVP241RUw3J4/edit?usp=sharing",
      doutrinas: "https://docs.google.com/document/d/1LwrV0gPkA0QCRinGGXtQF0bsaWri-rQZOdPiVmCPVus/edit?usp=sharing",
      secoes: "https://docs.google.com/spreadsheets/d/1Rw6o7O1rAjVC4XCDFwe6L0vInKSQsBvYZsWm6Rb1pfE/edit?gid=0#gid=0",
      crimes: "https://docs.google.com/document/d/1iGnC80f9COCirKVGHYm5Nr9xSr6hodYHCDl3IAXZvoY/edit?tab=t.0",
    };

    // Converte links do Google Docs/Sheets para /preview (melhor para iframe)
    function toEmbedUrl(url) {
      if (!url) return url;
      if (!/^https?:\/\//i.test(url)) url = "https://" + url;
      try {
        const u = new URL(url);
        if (u.hostname !== "docs.google.com") return url;
        const parts = u.pathname.split("/").filter(Boolean);
        const type = parts[0]; // "document" | "spreadsheets" | ...
        const idIndex = parts.findIndex(p => p === "d");
        const fileId = idIndex >= 0 ? parts[idIndex + 1] : null;
        if (fileId) {
          const frag = u.hash || "";
          return `https://docs.google.com/${type}/d/${fileId}/preview${frag}`;
        }
      } catch(e) {}
      return url;
    }

    // ----------------- SOMENTE LEITURA: HIERARQUIA -----------------
    // Este componente carrega dados p√∫blicos (GET) do site original e s√≥ permite visualizar.
    // Nenhuma rota de escrita (POST/PUT/DELETE) √© chamada aqui.
    function HierarquiaViewer({ dataUrl }) {
      const [people, setPeople] = useState([]);
      const [query, setQuery] = useState("");
      const [selectedId, setSelectedId] = useState(null);
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        let cancel = false;
        setLoading(true);
        fetch(dataUrl, { method: 'GET', mode: 'cors', credentials: 'omit' })
          .then(async (r) => {
            if (!r.ok) throw new Error(`Falha ao carregar dados (${r.status})`);
            return r.json();
          })
          .then((json) => {
            if (cancel) return;
            // Flex√≠vel: aceita dois formatos comuns
            // 1) { pessoas: [ { id, nome, patente, setor, ... } ] }
            // 2) [ { id, nome, patente, setor, ... } ]
            const arr = Array.isArray(json) ? json : (json?.pessoas || json?.members || []);
            setPeople(Array.isArray(arr) ? arr : []);
            setLoading(false);
          })
          .catch((e) => { if (!cancel) { setError(e.message); setLoading(false); } });
        return () => { cancel = true; };
      }, [dataUrl]);

      const filtered = useMemo(() => {
        const q = query.trim().toLowerCase();
        if (!q) return people;
        return people.filter(p => [p.nome, p.name, p.patente, p.rank, p.setor, p.sector, p.matricula, p.id]
          .filter(Boolean)
          .some(v => String(v).toLowerCase().includes(q)));
      }, [people, query]);

      const active = useMemo(() => {
        if (!selectedId && filtered.length) return filtered[0];
        return filtered.find(p => String(p.id) === String(selectedId));
      }, [filtered, selectedId]);

      return (
        <div className="space-y-4">
          <div className="rounded-xl border border-white/10 p-3 bg-slate-900/40 backdrop-blur">
            <div className="flex flex-col md:flex-row gap-3">
              <input
                type="text"
                placeholder="Buscar por nome, patente, setor..."
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                className="flex-1 px-3 py-2 rounded-lg bg-slate-950 border border-white/10 outline-none"
              />
              <select
                className="md:w-80 px-3 py-2 rounded-lg bg-slate-950 border border-white/10"
                value={selectedId || ''}
                onChange={(e) => setSelectedId(e.target.value)}
              >
                {filtered.map(p => (
                  <option key={p.id ?? p.nome} value={p.id ?? p.nome}>
                    {(p.patente || p.rank ? `[${p.patente || p.rank}] ` : '')}{p.nome || p.name}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {loading && (
            <div className="px-3 py-2 rounded-xl border border-white/10 bg-slate-900/60 text-sm text-slate-400">Carregando hierarquia‚Ä¶</div>
          )}
          {error && (
            <div className="px-3 py-2 rounded-xl border border-amber-400/30 bg-amber-500/10 text-amber-200 text-sm">{error}. Verifique a URL p√∫blica de dados.</div>
          )}

          {active && !loading && !error && (
            <div className="grid md:grid-cols-3 gap-4">
              <div className="md:col-span-1 rounded-xl border border-white/10 p-4 bg-slate-900/40">
                <div className="text-xs uppercase tracking-widest text-slate-400">Selecionado</div>
                <div className="text-lg font-bold">{active.nome || active.name}</div>
                <div className="text-slate-300">{active.patente || active.rank || 'Sem patente'}</div>
                {active.matricula && <div className="text-slate-400 text-sm">Matr√≠cula: {active.matricula}</div>}
                {active.setor && <div className="text-slate-400 text-sm">Setor: {active.setor}</div>}
              </div>

              <div className="md:col-span-2 rounded-xl border border-white/10 p-4 bg-slate-900/40 space-y-2">
                <div className="text-xs uppercase tracking-widest text-slate-400">Informa√ß√µes</div>
                <table className="w-full text-sm">
                  <tbody className="[&_tr]:border-b [&_tr]:border-white/10">
                    {Object.entries(active).map(([k, v]) => (
                      <tr key={k}>
                        <td className="py-2 pr-3 text-slate-400 whitespace-nowrap">{k}</td>
                        <td className="py-2 text-slate-100 break-words">{String(v)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                <div className="text-xs text-slate-500">Somente leitura ‚Äî altera√ß√µes s√≥ podem ser feitas pelo site original.</div>
              </div>
            </div>
          )}

          <div className="rounded-xl border border-amber-400/30 bg-amber-500/10 text-amber-200 text-xs p-3">
            Dica: caso precise abrir a p√°gina oficial para confirmar dados, use o bot√£o abaixo. Edi√ß√£o n√£o √© permitida a partir deste painel.
            <div className="mt-2">
              <a href={RAW_LINKS.hierarquiaPublicView} target="_blank" rel="noreferrer" className="px-3 py-2 rounded-lg border border-amber-400/40 hover:bg-amber-500/20">Abrir site oficial (view)</a>
            </div>
          </div>
        </div>
      );
    }

    // Itens da interface
    const CONFIG = {
      brand: { name: "ROTA ¬∑ Painel √önico", badge: "GTA RP" },
      sections: [
        {
          label: "Sistemas",
          items: [
            { id: "ponto", name: "Bate-Ponto", url: RAW_LINKS.ponto, icon: "‚è±Ô∏è", sandbox: null },
            { id: "rso", name: "RSO Online", url: RAW_LINKS.rso, icon: "üìã", sandbox: null },
          ],
        },
        {
          label: "Documentos do Batalh√£o",
          items: [
            // Hierarquia agora √© um VISUALIZADOR local somente-leitura (sem iframe edit√°vel)
            { id: "hierarquia", name: "Hierarquia do Batalh√£o (Somente leitura)", type: 'hierarquia' , icon: "üèõÔ∏è" },
            { id: "fardamentos", name: "Fardamentos do Batalh√£o", url: RAW_LINKS.fardamentos, icon: "üéΩ", sandbox: null },
            { id: "doutrinas", name: "Doutrinas e Regimento Interno", url: RAW_LINKS.doutrinas, icon: "üìú", sandbox: null },
            { id: "secoes", name: "Se√ß√µes Internas do Batalh√£o", url: RAW_LINKS.secoes, icon: "üóÇÔ∏è", sandbox: null },
            { id: "crimes", name: "Crimes Militares", url: RAW_LINKS.crimes, icon: "‚öñÔ∏è", sandbox: null },
          ],
        },
      ],
    };

    // ----------------- COMPONENTES -----------------
    function Sidebar({ sections, activeId, onSelect }) {
      return (
        <aside className="w-80 shrink-0 border-r border-white/10 bg-slate-900/40 backdrop-blur">
          <div className="p-4 border-b border-white/10">
            <div className="text-xs uppercase tracking-widest text-slate-400">{CONFIG.brand.badge}</div>
            <div className="font-black text-lg">{CONFIG.brand.name}</div>
          </div>

          <nav className="p-2">
            {sections.map((sec) => (
              <div key={sec.label} className="mb-3">
                <div className="px-2 py-1 text-xs uppercase tracking-widest text-slate-400">{sec.label}</div>
                <div className="mt-1 space-y-1">
                  {sec.items.map((it) => (
                    <button
                      key={it.id}
                      onClick={() => onSelect(it.id)}
                      className={`w-full text-left px-3 py-2 rounded-xl transition border flex items-center gap-2 ${
                        activeId === it.id
                          ? "bg-amber-500 text-slate-900 border-amber-400"
                          : "border-white/10 hover:bg-white/5"
                      }`}
                    >
                      <span className="text-base">{it.icon}</span>
                      <div>
                        <div className="font-semibold text-sm">{it.name}</div>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            ))}
          </nav>

          <div className="p-3 mt-auto text-[11px] text-slate-500">
            <div>v0.7 ‚Äî Painel Unificado (hierarquia somente leitura)</div>
          </div>
        </aside>
      );
    }

    function Topbar({ title }) {
      return (
        <header className="sticky top-0 z-10 bg-slate-950/70 backdrop-blur border-b border-white/10">
          <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
            <div className="h-9 w-9 rounded-lg grid place-items-center font-black border border-amber-500/40 bg-slate-900/60">R</div>
            <div className="font-bold">{title}</div>
          </div>
        </header>
      );
    }

    function Frame({ url, sandbox }) {
      const [loaded, setLoaded] = useState(false);
      const [blocked, setBlocked] = useState(false);

      // Converte /preview para docs; mant√©m outras URLs
      const resolvedUrl = useMemo(() => toEmbedUrl(url), [url]);

      useEffect(() => {
        setLoaded(false);
        setBlocked(false);
      }, [resolvedUrl]);

      useEffect(() => {
        const t = setTimeout(() => { if (!loaded) setBlocked(true); }, 5000);
        return () => clearTimeout(t);
      }, [loaded, resolvedUrl]);

      // Sandbox mais restrito: sem same-origin e sem forms; impede scripts do iframe de mexerem fora dele
      const iframeSandbox = sandbox ?? 'allow-scripts allow-downloads';

      return (
        <div className="relative h-[calc(100vh-120px)]">
          {!loaded && (
            <div className="absolute inset-0 grid place-items-center text-slate-400">
              <div className="px-3 py-2 rounded-xl border border-white/10 bg-slate-900/60 text-sm">
                Carregando conte√∫do‚Ä¶
              </div>
            </div>
          )}
          {blocked && (
            <div className="absolute top-3 right-3 px-3 py-2 rounded-xl border border-amber-400/30 bg-amber-500/10 text-amber-200 text-xs">
              Caso o documento n√£o permita incorpora√ß√£o, verifique permiss√µes do Google.
            </div>
          )}
          <iframe
            title="app-frame"
            src={resolvedUrl}
            className="w-full h-full rounded-xl border border-white/10 bg-slate-950"
            referrerPolicy="no-referrer"
            sandbox={iframeSandbox}
            onLoad={() => setLoaded(true)}
          ></iframe>
        </div>
      );
    }

    function App() {
      const flatItems = useMemo(() => CONFIG.sections.flatMap(s => s.items), []);
      const [active, setActive] = useState(flatItems[0]?.id || "");
      const activeItem = useMemo(() => flatItems.find(x => x.id === active), [active, flatItems]);

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100">
          <Topbar title={activeItem?.name || CONFIG.brand.name} />
          <div className="max-w-7xl mx-auto p-4 flex gap-4">
            <Sidebar
              sections={CONFIG.sections}
              activeId={active}
              onSelect={setActive}
            />
            <main className="flex-1">
              {/* Renderiza√ß√£o condicional: hierarquia vira viewer local somente-leitura */}
              {activeItem?.type === 'hierarquia' ? (
                <HierarquiaViewer dataUrl={RAW_LINKS.hierarquiaData} />
              ) : (
                <Frame url={activeItem?.url || ""} sandbox={activeItem?.sandbox || null} />
              )}
            </main>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
